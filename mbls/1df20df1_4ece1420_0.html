<html><head></head>
<body>

<div><br></div><div><div><b><font class="Apple-style-span" face="Consolas"><br></font></b></div><div><font class="Apple-style-span" face="Consolas"><b>问题描述</b></font></div><div><span class="Apple-style-span" style="font-family: Consolas; "><span class="Apple-style-span" style="line-height: 22px; "><br></span></span></div><div><span class="Apple-style-span" style="font-family: Consolas; "><span class="Apple-style-span" style="line-height: 22px; ">&nbsp; &nbsp; 一台服务器上，使用同一个Web环境，同一个虚拟主机，装了两个Web应用，即两个不同的网站放在同一环境里，有不同的数据库和代码。</span></span></div><div><span class="Apple-style-span" style="font-family: Consolas; "><span class="Apple-style-span" style="line-height: 22px; "><br></span></span></div><div><span class="Apple-style-span" style="font-family: Consolas; "><span class="Apple-style-span" style="line-height: 22px; ">&nbsp; &nbsp; 但是他们对会话（即用户是否已登录）</span></span><span class="Apple-style-span" style="font-family: Consolas; line-height: 22px; ">的判断是基于同样&nbsp;session 变量，（如，都根据 $_SESSION['username'] 有值来判断用户已登录），导致：在客户端，若使用同一浏览器，登录第一个网站后，第二个网站打开也变为已登录状态，这里退出第二个网站后，第一个网站也退出登录。而用不同的浏览器不存在此问题。</span></div></div><div><span class="Apple-style-span" style="font-family: Consolas; line-height: 22px; "><br></span></div><div><span class="Apple-style-span" style="font-family: Consolas; line-height: 22px; ">&nbsp; &nbsp; （<font class="Apple-style-span" color="#0000ff">同一浏览器，两个窗口A, B 同时分别登录同一web服务器的两个网站a, b，因为使用了同一个session变量判断，导致A登录后，B就直接是已登录状态了</font>）</span></div><div><span class="Apple-style-span" style="font-family: Consolas; line-height: 22px; "><br></span></div><div><span class="Apple-style-span" style="font-family: Consolas; line-height: 22px; "><br></span></div><div><span class="Apple-style-span" style="font-family: Consolas; line-height: 22px; "><br></span></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><b>原因分析</b></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">&nbsp; &nbsp; session id 应该是由浏览器 cookie 存放在客户端本地的，同一浏览器的各窗口或标签同享，打开不同的网站，都会把这些 cookie 发送到服务器；客户端不同的浏览器应该不会共享这个 cookie. (当然session id 所处的文件会根据情况清除)</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">&nbsp; &nbsp; 而在服务器端，同一web环境下（见问题描述的定义），应该也是共享服务器端的本地 session 文件，这时，若同一环境下的不同应用又基于同一 session 变量来判断，就会出现共享的问题。</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><b>解决办法</b></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">&nbsp; &nbsp; 每次用户登录时生成一个随机数，将判断用户是否登录的 session 变量（$_SESSION['username']一维数组中的元素）变为二维数组中的元素($_SESSION['random']['username'])，由于每个会话对应一个 session id, 此 id 由服务器产生而发给客户端，即使同一Web服务器环境下的不同应用，理应具有不同的 session id。</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">&nbsp; &nbsp; 但是若仅使用 session_start() 之后再获取 session_id()，由于先连接的应用已经开启了一个session，因而后面的应用会再次使用同一session.解决方案如下：</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">&nbsp; &nbsp; a. 得到一个唯一的键值(notusmlm为网站的名称，不同网站不要相同)</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><div>&nbsp; &nbsp; &nbsp; &nbsp; <font class="Apple-style-span" color="#ff00ff">session_start();</font></div><div><font class="Apple-style-span" color="#ff00ff">&nbsp; &nbsp; &nbsp; &nbsp; $sessionkey = session_id().md5(md5('notusmlm'));</font></div><div><br></div><div>&nbsp; &nbsp; b. 判断时使用</div><div>&nbsp; &nbsp; &nbsp; &nbsp; <font class="Apple-style-span" color="#ff00ff">$_SESSION[$sessionkey]['username']</font></div><div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">&nbsp; &nbsp; 核心：使服务器端，同一Web环境下的不同应用使用的 session 变量不同</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">遗留问题</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;">&nbsp; &nbsp; session_destroy之后，AB同时退出</span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><div><font class="Apple-style-span" face="Consolas"><span class="Apple-style-span" style="line-height: 22px;"><br></span></font></div><script type="text/javascript" language="javascript" src="jquery.js"></script><script type="text/javascript" language="javascript" src="itemlink.js"></script></body></html>